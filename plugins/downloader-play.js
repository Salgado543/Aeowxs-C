import I from'fs';import G from'yt-search';import L from'node-fetch';import{interactiveUtils}from'../src/libraries/base/interactive.js';const configContent=I['readFileSync']('./config.js','utf-8');if(!configContent['includes']('Luna-Botv6'))throw new Error('Handler\x20bloqueado');const APIS=[{'url':'https://api.stellarwa.xyz','key':'paymonbest','type':'stellar'},{'url':'https://noobs-api.top','type':'fallback'}];function bar(W){const n=0xa;return'ğŸŸ©'['repeat'](W)+'â¬œ'['repeat'](n-W);}async function sendProgress(W,n,d){try{return await W['sendMessage'](n['chat'],{'text':d},{'quoted':n});}catch(F){return null;}}async function editProgress(W,n,d){try{if(!n||!n['remoteJid'])return null;return await W['sendMessage'](n['remoteJid'],{'text':d,'edit':n});}catch(F){return null;}}async function fetchBuffer(W){const n=new AbortController(),d=setTimeout(()=>n['abort'](),0x15f90);try{const F=await L(W,{'signal':n['signal'],'headers':{'User-Agent':'Mozilla/5.0'}});clearTimeout(d);if(!F['ok'])throw new Error('HTTP\x20'+F['status']);return await F['buffer']();}catch(v){clearTimeout(d);throw v;}}async function fetchWithAPIs(W,n){for(const d of APIS){try{let F;if(d['type']==='stellar'){const B=n==='mp3'?'128':'360',k=n==='mp3'?'/dl/ytmp3':'/dl/ytmp4';F=''+d['url']+k+'?url='+encodeURIComponent(W)+'&key='+d['key']+'&quality='+B;}else F=d['url']+'/dipto/ytDl3?link='+encodeURIComponent(W)+'&format='+n;const v=new AbortController(),A=setTimeout(()=>v['abort'](),0x15f90),T=await L(F,{'signal':v['signal'],'headers':{'User-Agent':'Mozilla/5.0','Accept':'application/json'}});clearTimeout(A);if(!T['ok'])continue;const c=await T['json']();if(d['type']==='stellar'){if(!c['status']||!c['data']||!c['data']['dl'])continue;return{'downloadLink':c['data']['dl'],'title':c['data']['title']||'Media'};}else{if(!c['downloadLink'])continue;return{'downloadLink':c['downloadLink'],'title':c['title']||'Media'};}}catch(m){continue;}}throw new Error('âŒ\x20Todas\x20las\x20APIs\x20fallaron.\x20Intenta\x20de\x20nuevo.');}async function downloadMedia(W,n,d,F){let v=null;try{const A=F['match'](/v=([^&]+)/)?.[0x1]||F['replace']('https://youtu.be/','')['split']('?')[0x0],T=Date['now'](),c=await sendProgress(W,n,'ğŸŒ™ğŸ¤–\x20*LunaBot*\x0a'+bar(0x1)+'\x0aâ³\x20Preparando\x20descarga');if(!c)throw new Error('No\x20se\x20pudo\x20enviar\x20mensaje\x20de\x20progreso');v=c['key'];const B=d==='ytmp3'?'mp3':'mp4';await editProgress(W,v,'ğŸŒ™ğŸ¤–\x20*LunaBot*\x0a'+bar(0x3)+'\x0ağŸ”\x20Consultando\x20APIs...');const k=await fetchWithAPIs(F,B);if(!k['downloadLink']){await editProgress(W,v,'ğŸŒ™ğŸ¤–\x20*LunaBot*\x0aâŒ\x20Error\x20al\x20descargar');return;}await editProgress(W,v,'ğŸŒ™ğŸ¤–\x20*LunaBot*\x0a'+bar(0x6)+'\x0aâ¬‡ï¸\x20Descargando\x20'+B['toUpperCase']()+'...');const x=k['downloadLink']['includes']('.m3u8');if(d==='ytmp3')try{if(x)throw new Error('Formato\x20M3U8');await W['sendMessage'](n['chat'],{'audio':{'url':k['downloadLink']},'mimetype':'audio/mpeg','fileName':(k['title']||'audio')+'.mp3','ptt':![]},{'quoted':n});}catch{await editProgress(W,v,'ğŸŒ™ğŸ¤–\x20*LunaBot*\x0a'+bar(0x7)+'\x0ağŸ“¥\x20Descargando\x20buffer...');const Q=await fetchBuffer(k['downloadLink']);await W['sendMessage'](n['chat'],{'audio':Q,'mimetype':'audio/mpeg','fileName':(k['title']||'audio')+'.mp3','ptt':![]},{'quoted':n});}if(d==='ytmp4')try{if(x)throw new Error('Formato\x20M3U8');await W['sendMessage'](n['chat'],{'video':{'url':k['downloadLink']},'mimetype':'video/mp4','caption':k['title']||'ğŸ¬\x20Video'},{'quoted':n});}catch{await editProgress(W,v,'ğŸŒ™ğŸ¤–\x20*LunaBot*\x0a'+bar(0x7)+'\x0ağŸ“¥\x20Descargando\x20buffer...');const O=await fetchBuffer(k['downloadLink']);await W['sendMessage'](n['chat'],{'video':O,'mimetype':'video/mp4','caption':k['title']||'ğŸ¬\x20Video'},{'quoted':n});}const S=((Date['now']()-T)/0x3e8)['toFixed'](0x2),h=d==='ytmp4'?'ğŸ¬\x20Video':'ğŸµ\x20MÃºsica';await editProgress(W,v,'ğŸŒ™ğŸ¤–\x20*LunaBot*\x0a'+bar(0xa)+'\x0aâœ…\x20'+h+'\x20descargada\x20en\x20'+S+'s\x0ağŸ“\x20'+k['title']);}catch(w){try{await W['reply'](n['chat'],'âŒ\x20Error:\x20'+w['message']+'\x0a\x0a_Intenta\x20de\x20nuevo\x20en\x20unos\x20segundos_',n);}catch(a){console['error']('Error\x20enviando\x20mensaje:',a['message']);}}}let handler=async(W,{conn:n,text:d,command:F,usedPrefix:v})=>{try{if(F==='play'){if(!d)return n['reply'](W['chat'],'Escribe\x20el\x20nombre\x20de\x20la\x20canciÃ³n',W);try{const A=await G(d),T=A['videos']?.[0x0];if(!T)return n['reply'](W['chat'],'No\x20se\x20encontrÃ³\x20la\x20canciÃ³n',W);const c='https://youtu.be/'+T['videoId'],B=[['ğŸµ\x20Audio',v+'ytmp3\x20'+c],['ğŸ¬\x20Video',v+'ytmp4\x20'+c]];await interactiveUtils['sendNCarousel'](n,W['chat'],'ğŸ¶\x20*'+T['title']+'*\x0ağŸ‘¤\x20'+T['author']?.['name']+'\x0aâ±ï¸\x20'+T['timestamp'],'Luna-Bot',T['thumbnail'],B,null,null,null,W,{});}catch(k){n['reply'](W['chat'],'âŒ\x20Error\x20en\x20bÃºsqueda:\x20'+k['message'],W);}}if(F==='ytmp3'||F==='ytmp4'){if(!d)return n['reply'](W['chat'],'Falta\x20el\x20enlace',W);await downloadMedia(n,W,F,d);}}catch(x){console['error']('Error\x20en\x20handler:',x['message']);}};handler['command']=['play','ytmp3','ytmp4'],handler['tags']=['downloader'],handler['help']=['play\x20nombre','ytmp3\x20url','ytmp4\x20url'];export default handler;
